{{ define "main" }}
<main class="main list" role="main">
    {{- with .Title }}
    <header class="main__header">
        <h1 class="main__title">{{ . }}</h1>
    </header>
    {{- end }}
    {{- with .Content }}
    <div class="content main__content clearfix">
        {{ . }}
    </div>
    {{- end }}

    <!-- Debug info (apenas para desenvolvimento) -->
    <!-- 
    Total pages: {{ .Paginator.TotalPages }}
    Current page: {{ .Paginator.PageNumber }}
    Has next: {{ .Paginator.HasNext }}
    Posts this page: {{ len .Paginator.Pages }}
    Total posts: {{ len .Site.RegularPages }}
    -->

    <!-- Container para posts com rolagem infinita -->
    <div id="infinite-content" class="list__content">
        {{- range .Paginator.Pages }}
            {{- .Render "summary" }}
        {{- end }}
    </div>

    <!-- Loading indicator -->
    <div id="loading-indicator" style="display: none; text-align: center; padding: 20px; color: #666;">
        <div class="loading-spinner">üîÑ Carregando mais not√≠cias...</div>
    </div>

    <!-- Bot√£o manual como fallback -->
    {{- if .Paginator.HasNext }}
    <div id="load-more-container" style="text-align: center; margin: 30px 0;">
        <button id="load-more-btn" class="btn" style="background: #333; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
            Carregar Mais Not√≠cias
        </button>
    </div>
    {{- end }}

    <!-- Pagina√ß√£o oculta (usada pelo JavaScript) -->
    <nav class="pagination" style="display: none;">
        {{- if .Paginator.HasNext }}
        <a class="pagination__next" href="{{ .Paginator.Next.URL }}">Pr√≥xima</a>
        {{- end }}
    </nav>

    <!-- Script melhorado -->
    <script>
        (function() {
            console.log('üöÄ Infinite scroll iniciado');
            
            let loading = false;
            let hasMore = {{ .Paginator.HasNext }};
            let pageNumber = {{ .Paginator.PageNumber }};
            let totalPages = {{ .Paginator.TotalPages }};
            let postsThisPage = {{ len .Paginator.Pages }};
            
            console.log(`üìä Status inicial: p√°gina ${pageNumber}/${totalPages}, hasMore: ${hasMore}, posts: ${postsThisPage}`);
            
            const loadingIndicator = document.getElementById('loading-indicator');
            const infiniteContent = document.getElementById('infinite-content');
            const loadMoreBtn = document.getElementById('load-more-btn');
            
            async function loadMorePosts() {
                if (loading || !hasMore) {
                    console.log('‚ùå N√£o carregando:', {loading, hasMore});
                    return;
                }
                
                const nextLink = document.querySelector('.pagination__next');
                if (!nextLink) {
                    console.log('‚ùå Link next n√£o encontrado');
                    hasMore = false;
                    return;
                }
                
                loading = true;
                loadingIndicator.style.display = 'block';
                if (loadMoreBtn) loadMoreBtn.textContent = 'Carregando...';
                
                try {
                    console.log('üì° Fazendo fetch:', nextLink.href);
                    const response = await fetch(nextLink.href);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Buscar novos posts
                    const newPosts = doc.querySelectorAll('#infinite-content .list__item');
                    console.log(`üìÑ Novos posts encontrados: ${newPosts.length}`);
                    
                    if (newPosts.length === 0) {
                        console.log('‚ùå Nenhum post novo encontrado');
                        hasMore = false;
                        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
                        return;
                    }
                    
                    // Adicionar posts com anima√ß√£o
                    newPosts.forEach((post, index) => {
                        const clonedPost = post.cloneNode(true);
                        clonedPost.style.opacity = '0';
                        clonedPost.style.transform = 'translateY(20px)';
                        infiniteContent.appendChild(clonedPost);
                        
                        // Animar entrada
                        setTimeout(() => {
                            clonedPost.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                            clonedPost.style.opacity = '1';
                            clonedPost.style.transform = 'translateY(0)';
                        }, index * 100);
                    });
                    
                    // Atualizar pagina√ß√£o
                    const newNextLink = doc.querySelector('.pagination__next');
                    const currentPagination = document.querySelector('.pagination');
                    
                    if (newNextLink) {
                        currentPagination.innerHTML = `<a class="pagination__next" href="${newNextLink.href}">Pr√≥xima</a>`;
                        pageNumber++;
                        console.log(`‚úÖ P√°gina ${pageNumber} carregada`);
                        if (loadMoreBtn) loadMoreBtn.textContent = 'Carregar Mais Not√≠cias';
                    } else {
                        hasMore = false;
                        currentPagination.innerHTML = '';
                        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
                        console.log('üèÅ N√£o h√° mais p√°ginas');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar:', error);
                    hasMore = false;
                    if (loadMoreBtn) loadMoreBtn.textContent = 'Erro ao carregar';
                } finally {
                    loading = false;
                    loadingIndicator.style.display = 'none';
                }
            }
            
            // Listener de scroll com debounce
            let scrollTimeout;
            window.addEventListener('scroll', function() {
                if (scrollTimeout) clearTimeout(scrollTimeout);
                
                scrollTimeout = setTimeout(function() {
                    if (!loading && hasMore) {
                        const scrollPosition = window.innerHeight + window.scrollY;
                        const threshold = document.body.offsetHeight - 800;
                        
                        if (scrollPosition >= threshold) {
                            console.log('üîΩ Trigger de scroll ativado');
                            loadMorePosts();
                        }
                    }
                }, 150);
            });
            
            // Listener do bot√£o manual
            if (loadMoreBtn) {
                loadMoreBtn.addEventListener('click', function() {
                    console.log('üñ±Ô∏è Bot√£o clicado');
                    loadMorePosts();
                });
            }
            
            // Log inicial
            if (!hasMore) {
                console.log('‚ÑπÔ∏è Apenas uma p√°gina - rolagem infinita n√£o necess√°ria');
            }
            
        })();
    </script>
</main>
{{ end }}
