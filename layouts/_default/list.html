{{ define "main" }}
<main class="main list" role="main">
    {{- with .Title }}
    <header class="main__header">
        <h1 class="main__title">{{ . }}</h1>
    </header>
    {{- end }}
    {{- with .Content }}
    <div class="content main__content clearfix">
        {{ . }}
    </div>
    {{- end }}

    <!-- Container para posts com rolagem infinita -->
    <div id="infinite-content" class="list__content">
        {{- range .Paginator.Pages }}
            {{- .Render "summary" }}
        {{- end }}
    </div>

    <!-- Loading indicator -->
    <div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
        <div class="loading-spinner">Carregando mais notícias...</div>
    </div>

    <!-- Paginação oculta (usada pelo JavaScript) -->
    <nav class="pagination" style="display: none;">
        {{- if .Paginator.HasNext }}
        <a class="pagination__next" href="{{ .Paginator.Next.URL }}">Próxima</a>
        {{- end }}
    </nav>

    <!-- Script de rolagem infinita melhorado -->
    <script>
        (function() {
            let loading = false;
            let hasMore = {{ .Paginator.HasNext }};
            const loadingIndicator = document.getElementById('loading-indicator');
            const infiniteContent = document.getElementById('infinite-content');
            
            console.log('Infinite scroll initialized. HasMore:', hasMore);
            
            async function loadMorePosts() {
                if (loading || !hasMore) return;
                
                const nextLink = document.querySelector('.pagination__next');
                if (!nextLink) {
                    console.log('No next link found');
                    hasMore = false;
                    return;
                }
                
                loading = true;
                loadingIndicator.style.display = 'block';
                
                try {
                    console.log('Fetching:', nextLink.href);
                    const response = await fetch(nextLink.href);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Encontrar novos posts
                    const newPosts = doc.querySelectorAll('#infinite-content .list__item');
                    console.log('Found new posts:', newPosts.length);
                    
                    if (newPosts.length === 0) {
                        console.log('No more posts found');
                        hasMore = false;
                        return;
                    }
                    
                    // Adicionar novos posts
                    newPosts.forEach(post => {
                        infiniteContent.appendChild(post.cloneNode(true));
                    });
                    
                    // Atualizar link de paginação
                    const newNextLink = doc.querySelector('.pagination__next');
                    const currentPagination = document.querySelector('.pagination');
                    
                    if (newNextLink) {
                        currentPagination.innerHTML = `<a class="pagination__next" href="${newNextLink.href}">Próxima</a>`;
                    } else {
                        hasMore = false;
                        currentPagination.innerHTML = '';
                        console.log('No more pages available');
                    }
                    
                } catch (error) {
                    console.error('Error loading more posts:', error);
                    hasMore = false;
                } finally {
                    loading = false;
                    loadingIndicator.style.display = 'none';
                }
            }
            
            // Listener de scroll otimizado
            let scrollTimeout;
            window.addEventListener('scroll', function() {
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                
                scrollTimeout = setTimeout(function() {
                    if (!loading && hasMore) {
                        const scrollPosition = window.innerHeight + window.scrollY;
                        const threshold = document.body.offsetHeight - 1000; // Carregar 1000px antes do fim
                        
                        if (scrollPosition >= threshold) {
                            console.log('Loading more posts triggered');
                            loadMorePosts();
                        }
                    }
                }, 100); // Debounce de 100ms
            });
            
            // Adicionar estilos para loading
            const style = document.createElement('style');
            style.textContent = `
                .loading-spinner {
                    color: #666;
                    font-style: italic;
                }
                
                .loading-spinner::after {
                    content: '';
                    animation: dots 1.5s steps(5, end) infinite;
                }
                
                @keyframes dots {
                    0%, 20% { content: ''; }
                    40% { content: '.'; }
                    60% { content: '..'; }
                    80%, 100% { content: '...'; }
                }
                
                /* Suavizar aparição de novos posts */
                .list__item {
                    opacity: 0;
                    animation: fadeIn 0.5s ease-in-out forwards;
                }
                
                @keyframes fadeIn {
                    to { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
        })();
    </script>
</main>
{{ end }}
